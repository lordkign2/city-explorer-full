<!-- ./views/pages/country.ejs -->
<%- include('../partials/header') %>
<%- include('../partials/navbar') %>
<%- include('../partials/flashMessages') %>
<%- include('../partials/sidebar') %>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha512-sA+HxN1bV1EkfTY1K/UHn0PS+n0E9rPLwRaAYPFUJv87EYfYZU2pLQ1jBr69F9sFVq5UPw5P+glwGjjSp6z1hQ=="
  crossorigin=""
/>
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha512-o8gQd9gFhEhMggzFEblhEwK/pzrw+cEK3qH08HEw2sMwqKqKYBpO0bBrUzYwbK1NIKwfIOzFf9W0M0G27HCZAA=="
  crossorigin=""
></script>


<section class="max-w-5xl mx-auto mt-8 p-6 bg-white dark:bg-gray-900 rounded-lg shadow">
  <div class="flex items-center gap-2 mb-2">
    <img
      src="https://flagcdn.com/24x18/<%= country.code.toLowerCase() %>.png"
      alt="<%= country.name %> flag"
      class="inline-block w-5 h-3 rounded"
    />
  <h1 class="text-4xl font-bold mb-4 text-gray-800 dark:text-white"><%= country.name %></h1>
  </div>
  <!-- Country Info -->
  <div class="mb-6">
    
    <p class="text-lg text-gray-700 dark:text-gray-300"><strong>Code:</strong> <%= country.code %></p>
    <p class="text-lg text-gray-700 dark:text-gray-300"><strong>Region:</strong> <%= country.region || 'N/A' %></p>
    <p class="text-lg text-gray-700 dark:text-gray-300"><strong>Population:</strong> <%= country.population?.toLocaleString() || 'N/A' %></p>
    <p class="text-lg text-gray-700 dark:text-gray-300"><strong>Capital:</strong> <%= country.capital || 'N/A' %></p>
    <p class="text-lg text-gray-700 dark:text-gray-300"><strong>Currency:</strong> <%= country.currency || 'N/A' %></p>
  </div>

  <!-- Country Map -->
  
    <div id="map" class="h-64 rounded mb-6 shadow"></div>
<!-- Leaflet CSS -->


    <script>
      document.addEventListener('DOMContentLoaded', async () => {
        const countryName = "<%= country.name %>";
        const apiKey = "074065632fec49cf8ea28486935077c7";
    
        try {
          const res = await fetch(
            `https://api.opencagedata.com/geocode/v1/json?q=${encodeURIComponent(
              countryName
            )}&key=${apiKey}&limit=1`
          );
          const data = await res.json();
          
          if (data.results && data.results.length > 0) {
            const { lat, lng } = data.results[0].geometry;
    
            const map = L.map("map").setView([lat, lng], 5);
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
              maxZoom: 18,
              attribution: '&copy; OpenStreetMap contributors',
            }).addTo(map);
    
            L.marker([lat, lng])
              .addTo(map)
              .bindPopup(countryName)
              .openPopup();
          } else {
            alert("Could not find location for this country.");
          }
        } catch (error) {
          console.error("Geocoding failed:", error);
          alert("Something went wrong while fetching the map.");
        }
      });
    </script>
    


  <!-- Cities in Country -->
  <div>
    <h2 class="text-2xl font-semibold text-gray-700 dark:text-white mb-3">Cities in <%= country.name %></h2>
    <% if (cities.length === 0) { %>
      <p class="text-gray-500 dark:text-gray-400">No cities added yet.</p>
    <% } else { %>
      <ul class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <% cities.forEach(city => { %>
          <li class="bg-gray-100 dark:bg-gray-800 p-4 rounded shadow">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-white"><%= city.name %></h3>
            <a href="/cities/<%= city._id %>" class="text-indigo-600 dark:text-indigo-400 text-sm hover:underline">View</a>
          </li>
        <% }) %>
      </ul>
    <% } %>
  </div>
</section>

<%- include('../partials/footer') %>
