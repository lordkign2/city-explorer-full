<%- include('../partials/header') %>
<%- include('../partials/navbar') %>
<%- include('../partials/flashMessages') %>
<%- include('../partials/adminSidebar') %>

<section class="max-w-6xl mx-auto p-6 dark:bg-gray-900 bg-white rounded-xl shadow-xl mt-6">
  <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 gap-4">
    <h1 class="text-2xl font-bold dark:text-white">Manage Countries</h1>
    <div class="flex items-center gap-3">
      <input id="searchInput" type="text" placeholder="Search..." class="form-input rounded-md dark:bg-gray-800" />
      <select id="sortSelect" class="form-select rounded-md dark:bg-gray-800">
        <option value="name-asc">Name (A–Z)</option>
        <option value="name-desc">Name (Z–A)</option>
        <option value="code-asc">Code (A–Z)</option>
        <option value="code-desc">Code (Z–A)</option>
      </select>
      <a href="/admin/countries/new" class="inline-block px-4 py-2 rounded-md bg-indigo-600 text-white hover:bg-indigo-700 dark:bg-indigo-500 dark:hover:bg-indigo-400 transition shadow">
        + Add Country
      </a>
      
    </div>
  </div>

  <div class="overflow-x-auto rounded">
    <table class="min-w-full table-auto text-left bg-white dark:bg-gray-800">
      <thead class="bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-white">
        <tr>
          <th class="p-3">Name</th>
          <th class="p-3">Code</th>
          <th class="p-3">Actions</th>
        </tr>
      </thead>
      <tbody id="countryTable">
        <% if (countries.length === 0) { %>
          <tr>
            <td colspan="3" class="p-4 text-center text-gray-500 dark:text-gray-400">No countries found.</td>
          </tr>
        <% } else { %>
        <% countries.forEach(country => { %>
          <tr class="border-b dark:border-gray-600">
            <td class="p-3"><%= country.name %></td>
            <td class="p-3"><%= country.code %></td>
            <td class="p-3 space-x-2">
              <a href="/admin/countries/<%= country._id %>/edit" class="text-blue-500 hover:underline">Edit</a>
              <button
              class="text-red-500 hover:underline"
              onclick="openConfirmModal('<%= country._id %>')">Delete
              </button>
              <form id="delete-form-<%= country._id %>" action="/admin/countries/<%= country._id %>?_method=DELETE" method="POST" class="hidden"></form>
            </td>
          </tr>
        <% }) %>
        <% } %>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="mt-6 flex justify-center space-x-2">
    <% for (let i = 1; i <= totalPages; i++) { %>
      <a href="?page=<%= i %>" class="px-4 py-2 rounded border <%= currentPage === i ? 'bg-indigo-500 text-white' : 'bg-gray-100 dark:bg-gray-700 dark:text-white' %>">
        <%= i %>
      </a>
    <% } %>
  </div>
</section>

<!-- Confirmation Modal -->
<div id="confirmModal" class="fixed inset-0 z-50 bg-black bg-opacity-50 hidden items-center justify-center">
  <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl w-80">
    <h2 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Confirm Delete</h2>
    <p class="text-gray-600 dark:text-gray-300 mb-6">Are you sure you want to delete this country?</p>
    <div class="flex justify-end gap-4">
      <button onclick="closeConfirmModal()" class="px-4 py-2 rounded bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-white">Cancel</button>
      <button id="confirmDeleteBtn" class="px-4 py-2 rounded bg-red-600 text-white">Delete</button>
    </div>
  </div>
</div>

<script>
  let deleteFormId = null;

  function openConfirmModal(id) {
    deleteFormId = `delete-form-${id}`;
    document.getElementById('confirmModal').classList.remove('hidden');
    document.getElementById('confirmModal').classList.add('flex');
  }

  function closeConfirmModal() {
    deleteFormId = null;
    document.getElementById('confirmModal').classList.add('hidden');
    document.getElementById('confirmModal').classList.remove('flex');
  }

  document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
    if (deleteFormId) {
      document.getElementById(deleteFormId).submit();
    }
  });

  // Simple client-side filtering and sorting
  document.getElementById('searchInput').addEventListener('input', function () {
    const filter = this.value.toLowerCase();
    const rows = document.querySelectorAll('#countryTable tr');
    rows.forEach(row => {
      const name = row.children[0].textContent.toLowerCase();
      const code = row.children[1].textContent.toLowerCase();
      row.style.display = name.includes(filter) || code.includes(filter) ? '' : 'none';
    });
  });

  document.getElementById('sortSelect').addEventListener('change', function () {
    const [key, dir] = this.value.split('-');
    const rows = Array.from(document.querySelectorAll('#countryTable tr'));
    const sorted = rows.sort((a, b) => {
      const valA = a.children[key === 'name' ? 0 : 1].textContent;
      const valB = b.children[key === 'name' ? 0 : 1].textContent;
      return dir === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
    });
    const tbody = document.getElementById('countryTable');
    tbody.innerHTML = '';
    sorted.forEach(row => tbody.appendChild(row));
  });
</script>

<%- include('../partials/footer') %>
