<!-- ./views/pages/admin-cities.ejs -->
<%- include('../partials/header') %>
<%- include('../partials/navbar') %>
<%- include('../partials/flashMessages') %>
<%- include('../partials/adminSidebar') %>

<section class="max-w-6xl mx-auto p-6 mt-6 bg-white dark:bg-gray-900 rounded-xl shadow-xl">
  <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-6">
    <h1 class="text-2xl font-bold dark:text-white">Manage Cities</h1>
    
    <div class="flex items-center space-x-3 w-full sm:w-auto">
      <input
        type="text"
        id="searchInput"
        placeholder="Search cities..."
        class="form-input w-full sm:w-64 rounded-md border dark:border-gray-700 dark:bg-gray-800 dark:text-white px-3 py-2"
      />
      <a href="/admin/cities/new"
         class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 transition font-semibold text-sm">
         + Add City
      </a>
    </div>
  </div>

  <form id="bulkDeleteForm" action="/admin/cities/bulk-delete" method="POST">
    <div class="overflow-x-auto">
      <table class="min-w-full bg-white dark:bg-gray-800 rounded shadow table-auto">
        <thead class="bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-white text-sm">
          <tr>
            <th class="p-3 text-center"><input type="checkbox" id="selectAll" /></th>
            <th class="p-3 cursor-pointer">Name</th>
            <th class="p-3 cursor-pointer">Country</th>
            <th class="p-3 text-center">Actions</th>
          </tr>
        </thead>
        <tbody id="citiesTableBody">
          <% cities.forEach(city => { %>
            <tr class="border-b dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 text-sm">
              <td class="p-3 text-center">
                <input type="checkbox" name="ids" value="<%= city._id %>" class="city-checkbox" />
              </td>
              <td class="p-3"><%= city.name %></td>
              <td class="p-3"><%= city.country?.name || 'Unknown' %></td>
              <td class="p-3 text-center">
                <a href="/admin/cities/<%= city._id %>/edit" class="text-blue-500 hover:underline">Edit</a> |
                <form id="delete-form-<%= city._id %>" action="/admin/cities/<%= city._id %>?_method=DELETE" method="POST" class="inline">
                  <button type="submit" onclick="openConfirmModal('<%= city._id %>', event)" class="text-red-500 hover:underline">Delete</button>
                </form>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>

    <div class="mt-4 flex justify-between items-center">
      <button type="submit" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded font-medium">
        Delete Selected
      </button>

      
      <!-- <div class="space-x-2">
        <button class="px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-sm">Previous</button>
        <button class="px-3 py-1 rounded bg-indigo-600 text-white hover:bg-indigo-700 text-sm">1</button>
        <button class="px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-sm">Next</button>
      </div> -->
    </div>
  </form>
  <!-- Pagination UI Placeholder -->
  <% if (totalPages > 1) { %>
    <div class="mt-6 flex justify-center items-center gap-1">
      <% if (currentPage > 1) { %>
        <a href="?page=<%= currentPage - 1 %>" class="px-3 py-1 rounded-md bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-sm text-gray-800 dark:text-white">
          Previous
        </a>
      <% } %>
  
      <% for (let i = 1; i <= totalPages; i++) { %>
        <a href="?page=<%= i %>" class="px-3 py-1 rounded-md text-sm font-medium 
          <%= i === currentPage 
            ? 'bg-indigo-600 text-white' 
            : 'bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-800 dark:text-white' %>">
          <%= i %>
        </a>
      <% } %>
  
      <% if (currentPage < totalPages) { %>
        <a href="?page=<%= currentPage + 1 %>" class="px-3 py-1 rounded-md bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-sm text-gray-800 dark:text-white">
          Next
        </a>
      <% } %>
    </div>
  <% } %>
  
</section>

<!-- Confirmation Modal -->
<div id="confirmModal" class="fixed inset-0 z-50 bg-black bg-opacity-50 hidden items-center justify-center">
  <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl w-80">
    <h2 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Confirm Delete</h2>
    <p class="text-gray-600 dark:text-gray-300 mb-6">Are you sure you want to delete this country?</p>
    <div class="flex justify-end gap-4">
      <button onclick="closeConfirmModal()" class="px-4 py-2 rounded bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-white">Cancel</button>
      <button id="confirmDeleteBtn" class="px-4 py-2 rounded bg-red-600 text-white">Delete</button>
    </div>
  </div>
</div>

<script>
   let deleteFormId = null;

function openConfirmModal(id, event) {
  event.preventDefault()
  deleteFormId = `delete-form-${id}`;
  document.getElementById('confirmModal').classList.remove('hidden');
  document.getElementById('confirmModal').classList.add('flex');
}

function closeConfirmModal() {
  deleteFormId = null;
  document.getElementById('confirmModal').classList.add('hidden');
  document.getElementById('confirmModal').classList.remove('flex');
}

document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
  if (deleteFormId) {
    document.getElementById(deleteFormId).submit();
  }
});
  // Select All Logic
  document.getElementById('selectAll').addEventListener('change', function () {
    document.querySelectorAll('.city-checkbox').forEach(checkbox => {
      checkbox.checked = this.checked;
    });
  });

  // Live Search (basic front-end filter)
  const searchInput = document.getElementById('searchInput');
  const tableRows = document.querySelectorAll('#citiesTableBody tr');

  searchInput.addEventListener('input', function () {
    const searchTerm = this.value.toLowerCase();
    tableRows.forEach(row => {
      const cityName = row.children[1].textContent.toLowerCase();
      row.style.display = cityName.includes(searchTerm) ? '' : 'none';
    });
  });
</script>
<%- include('../partials/footer') %>