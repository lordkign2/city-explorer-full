<!-- ./views/pages/admin-users.ejs -->
<%- include('../partials/header') %>
<%- include('../partials/navbar') %>
<%- include('../partials/flashMessages') %>
<%- include('../partials/adminSidebar') %>

<section class="max-w-6xl mx-auto p-6 mt-6 bg-white dark:bg-gray-900 rounded-xl shadow-xl">
  <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-6">
    <h1 class="text-2xl font-bold dark:text-white">Manage Users</h1>
    <input
      type="text"
      id="searchInput"
      placeholder="Search users..."
      class="form-input w-full sm:w-64 rounded-md border dark:border-gray-700 dark:bg-gray-800 dark:text-white px-3 py-2"
    />
  </div>

  <div class="overflow-x-auto">
    <table class="min-w-full bg-white dark:bg-gray-800 rounded shadow table-auto">
      <thead class="bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-white text-sm">
        <tr>
          <th class="p-3">Username</th>
          <th class="p-3">Email</th>
          <th class="p-3">Role</th>
          <th class="p-3 text-center">Actions</th>
        </tr>
      </thead>
      <tbody id="usersTableBody">
        <% users.forEach(user => { %>
          <tr class="border-b dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 text-sm">
            <td class="p-3"><%= user.username %></td>
            <td class="p-3"><%= user.email %></td>
            <td class="p-3"><%= user.isAdmin ? 'Admin' : 'User' %></td>
            <td class="p-3 text-center space-y-2">
              <div class="space-x-2">
                <button
                  onclick="openEditModal('<%= user._id %>', '<%= user.username %>', '<%= user.email %>', <%= user.isAdmin %>)"
                  class="px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 transition"
                >
                  Edit
                </button>
                <form method="POST" action="/admin/users/<%= user._id %>/toggle-admin" class="inline">
                  <button
                    type="submit"
                    class="px-3 py-1 bg-yellow-500 text-white text-xs rounded hover:bg-yellow-600 transition"
                  >
                    <%= user.isAdmin ? 'Revoke Admin' : 'Make Admin' %>
                  </button>
                </form>
                <% if (user._id.toString() !== currentUser._id.toString()) { %>
                  <button
                    data-id="<%= user._id %>"
                    class="bg-red-500 text-white text-xs px-3 py-1 rounded hover:bg-red-600 deleteUserBtn"
                  >
                    Delete
                  </button>
                <% } else { %>
                  <span class="text-xs text-gray-400 italic">You</span>
                <% } %>
              </div>
            
              <% if (user._id.toString() !== currentUser._id.toString()) { %>
                <form method="POST" action="/admin/suspend" class="mt-2 space-y-1 text-left">
                  <input type="hidden" name="userId" value="<%= user._id %>" />
                  <input
                    type="number"
                    name="days"
                    placeholder="Days"
                    min="1"
                    required
                    class="w-20 text-xs px-2 py-1 rounded border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white"
                  />
                  <input
                    type="text"
                    name="reason"
                    placeholder="Reason"
                    class="text-xs px-2 py-1 rounded w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white"
                  />
                  <button
                    type="submit"
                    class="bg-red-400 hover:bg-red-500 text-white text-xs px-3 py-1 rounded w-full"
                  >
                    Suspend
                  </button>
                </form>
              <% } %>
            </td>
            
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>

  <% if (totalPages > 1) { %>
    <div class="mt-6 flex justify-center items-center gap-1">
      <% if (currentPage > 1) { %>
        <a href="?page=<%= currentPage - 1 %>" class="pagination-btn">Previous</a>
      <% } %>
      <% for (let i = 1; i <= totalPages; i++) { %>
        <a href="?page=<%= i %>" class="pagination-btn <%= i === currentPage ? 'bg-indigo-600 text-white' : '' %>"><%= i %></a>
      <% } %>
      <% if (currentPage < totalPages) { %>
        <a href="?page=<%= currentPage + 1 %>" class="pagination-btn">Next</a>
      <% } %>
    </div>
  <% } %>
</section>

<!-- Edit Modal -->
<div id="editUserModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-md">
    <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-white">Edit User</h2>
    <form method="POST" id="editUserForm">
      <input type="hidden" name="_id" id="editUserId" />

      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Username</label>
        <input type="text" name="username" id="editUsername" required
          class="w-full px-4 py-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
      </div>

      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email</label>
        <input type="email" name="email" id="editEmail" required
          class="w-full px-4 py-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
      </div>

      <div class="mb-4">
        <label class="flex items-center space-x-2">
          <input type="checkbox" name="isAdmin" id="editIsAdmin" class="form-checkbox" />
          <span class="text-sm text-gray-700 dark:text-gray-300">Make Admin</span>
        </label>
      </div>

      <div class="flex justify-end gap-2">
        <button type="button" onclick="closeEditModal()" class="px-4 py-2 bg-gray-300 text-sm rounded">Cancel</button>
        <button type="submit" class="px-4 py-2 bg-indigo-600 text-white text-sm rounded hover:bg-indigo-700">Save</button>
      </div>
    </form>
  </div>
</div>

<script>
  
    function openEditModal(id, username, email, isAdmin) {
      document.getElementById('editUserId').value = id;
      document.getElementById('editUsername').value = username;
      document.getElementById('editEmail').value = email;
      document.getElementById('editIsAdmin').checked = isAdmin;

      const form = document.getElementById('editUserForm');
      form.action = `/admin/users/${id}/edit`;

      document.getElementById('editUserModal').classList.remove('hidden');
    }

    function closeEditModal() {
      document.getElementById('editUserModal').classList.add('hidden');
    }

    document.querySelectorAll('.deleteUserBtn').forEach(button => {
    button.addEventListener('click', async () => {
      const userId = button.dataset.id;
      const confirmDelete = confirm('Are you sure you want to delete this user?');
      if (!confirmDelete) return;

      try {
        const res = await fetch(`/admin/users/${userId}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' }
        });

        if (res.ok) {
          button.closest('tr').remove();
        } else {
          alert('Failed to delete user.');
        }
      } catch (err) {
        console.error(err);
        alert('Error deleting user.');
      }
    });
  });
  
  // Live Search
  const searchInput = document.getElementById('searchInput');
  const tableRows = document.querySelectorAll('#usersTableBody tr');
  searchInput.addEventListener('input', function () {
    const term = this.value.toLowerCase();
    tableRows.forEach(row => {
      const userName = row.children[0].textContent.toLowerCase();
      row.style.display = userName.includes(term) ? '' : 'none';
    });
  });
</script>

<style>
  .pagination-btn {
    @apply px-3 py-1 rounded-md bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-sm text-gray-800 dark:text-white;
  }
</style>

<%- include('../partials/footer') %>
